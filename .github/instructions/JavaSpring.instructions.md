---
applyTo: '**'
---
# Workspace Instructions — Java / Spring Boot

## Цели
- Писать поддерживаемый и наблюдаемый сервис на Java 21 / Spring Boot 3.x.
- Минимизировать регрессии за счёт тестов, статанализа и CI.
- Автоматизировать рутину через Copilot Agent в чётких границах.

## Технологический стек
- Java 21, Spring Boot 3.x, Maven.
- Data: Spring Data JPA, PostgreSQL
- Документация API: springdoc-openapi.
- Тесты: JUnit 5, Mockito, Testcontainers, WebTestClient.
- Логирование: Simple Logging Facade for Java (SLF4J).
- Контейнеризация: Dockerfile + docker-compose для локалки.

## Стиль кода и качество
- Форматирование: Google Java Style (Spotless).
- Статический анализ: Error Prone.
- Нулевые контракты: аннотации @NonNull/@Nullable (JetBrains).
- Имена: английские, понятные; магических чисел не держать.
- Публичные контракты стабильны; изменения — через семантические версии.

## Архитектура
- Контроллеры тонкие: только валидация и оркестрация.
- Логика — в сервисах; доступ к данным — в репозиториях.
- DTO ≠ Entity; маппинг через MapStruct.
- Исключения: иерархия бизнес/технических; глобальный обработчик ошибок.
- Конфигурация через `application.yaml`; секреты — только переменные окружения.

## Безопасность
- Spring Security без WebSecurityConfigurerAdapter; методовые @PreAuthorize.
- В логах и ответах не раскрывать чувствительных данных.
- SQL только параметризованный; входные данные валидировать.
- Секреты не коммитить; пример в `.env.example`.

## Логирование и наблюдаемость
- Формат JSON; поля: timestamp, level, logger, message, traceId.
- Прокидывать correlation-id через MDC.
- Метрики Micrometer; healthchecks включены.

## Тестирование (Definition of Done)
- Unit-тесты на ключевую логику; интеграционные для критических путей.
- Покрытие затронутых веток не ниже 80% для изменённых модулей.
- Контрактные тесты для публичных эндпоинтов (статусы/схемы).
- Testcontainers для работы с БД.
- Нельзя мержить при красных тестах/линтерах.

## Миграции БД
- Только через Liquibase; у каждого changeSet — корректный rollback.
- Согласовывать destructive-операции (DROP/ALTER) через ADR.

## Git-процесс
- Бранчи feature/…, fix/…, chore/…; PR малые и атомарные.
- Conventional Commits.
- Code review обязательно; запрет force-push в protected-ветки.

## Документация
- OpenAPI актуален; README кратко описывает запуск и переменные окружения.
- ADR (MADR) для архитектурных решений в `docs/adr/`.

## Язык
- Ответы Copilot: русский.
- Комментарии и идентификаторы — английский.

## Правила для Copilot Agent
- Разрешено: читать/писать файлы (Editor), запускать тесты, собирать проект, генерировать миграции (без применения на проде), предлагать коммиты/PR.
- Запрос подтверждения перед: командами в терминале, изменениями CI, миграциями с деструктивными действиями.
- Коммиты — небольшими пачками с осмысленными сообщениями.